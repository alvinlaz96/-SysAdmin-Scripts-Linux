#!/bin/bash
######################################################################
#Script Name  :   Malware Reporter
#Description  :   Its cloned from my beta work Reach me through GitHub
#Author       :   Alvin Lazar C
#Email        :   alvin.la@endurance.com
######################################################################

clear;

unset dsh prt urs usrm mlc line jobd mid i k;

i=0 ;

#Function dsh print dashes.
dsh () { 

echo -e "\n##########################################\n";

};

echo -e "\n\nReport `hostname`\t`date +%d-%m-%Y` `dsh`";

#Function jobd doing Sending Mail, Printing complete report location, Creating hgfixlink, Upon admin inputs.
jobd () {

  while ((i < 1));

  do

    read -rep $'\n\nSuccessfully Changed File Permissions...!\n\nHow To Handle Outcome\n\n1. Paste_Link (l)\n2. System_Report (s)\n3. Mail_me (m)\n4. all (A)\n\n Press An Option : ' line; 

    if [ "$line" == "l" ];

      then

        echo -e "\nLink : `cat /ramdisk/mreports.txt |hpaste -k`" ;

        i=1;

    elif [ "$line" == "s" ];

      then

        echo -e "\nDetailed Report Stored In /ramdisk/mreports.txt\n";

        i=1;

    elif [ "$line" == "m" ];

      then

        read -rep $'\nEnter required mail:' mid; 

        echo -e "\n`sleep 2s`Email Successfully Sent to `cat /ramdisk/mreports.txt |mail -s "Malware Report" $mid >/dev/null`$mid\n";

        i=1;

     elif [ "$line" == "A" ];

      then

        echo -e "\n\e[1;42m I feel something bad about you ^(o_o)^ \e[0m\n";

        i=1;

     else

      echo -e "\n\e[1;41mI Thing You Hate Me Lot :(\e[0m\n\tGood Bye...";

      i=1;

     fi;

  done;

} ;

#Function prt doing Main_section stream job changing file permissions.
prt () { 

  echo -e " `cut -d: -f1 $usrm/malware.txt | head -$mlc | xargs -I{} chmod 000 {};`" 

  k=0;

  echo -en "Changing File Permission Of $urs" && 

  while [ "$k" -lt 5 ]; 

    do 

      printf "." sleep 1; 

      sleep 1; 

      k=$(($k+1));

      if [ "$k" -eq 5 ];  

        then 

          echo -e "[OK]"; 

      fi; 

  done;

#Main Section 1 which consists of calculating reported users, linking malware report formats from 2 hgfixlinks and making process of report.
 (
  if [ "$mlc" -lt 50 ] ;
  
   then 
       
     (
      
       echo -e "\n\n`dsh`\n$urs\t`(cpapi2 --user=$urs SubDomain listsubdomains | grep -m1 root | awk '{print $2}')`\t`hostname` `date` `dsh`" &&

       curl -sk http://hgfix.net/paste/view/raw/04fa12a4 && cut -d: -f1 $usrm/malware.txt | head -$mlc && 

       echo -e "\n`dsh`" &&

       curl -sk http://hgfix.net/paste/view/raw/e51f2eaf && cut -d: -f1 $usrm/malware.txt | head -$mlc ;

     )  >> /ramdisk/mreports.txt;echo;
      
  else 
         
     (
   
        echo -e "\n\n`dsh`\n$urs\t`(cpapi2 --user=$urs SubDomain listsubdomains | grep -m1 root | awk '{print $2}')`\t`hostname` `date` `dsh`" &&

        curl -sk http://hgfix.net/paste/view/raw/04fa12a4 && cut -d: -f1 $usrm/malware.txt | head -50 && 

        echo -e "\n`dsh`" &&

        curl -sk http://hgfix.net/paste/view/raw/e51f2eaf && cut -d: -f1 $usrm/malware.txt | head -50 ;
      
     )  >> /ramdisk/mreports.txt;echo;

  fi;

 )

} &&

#Main Section 2 guiding what to do when malware count goes high and low.
(

  for urs in `cat /ramdisk/musers.txt`; 

    do 

      usrm=`(uapi --user=$urs DomainInfo domains_data format=hash | grep homedir)|head -1 | cut -d : -f2` && 

      mlc=`grep -m1 Infected  $usrm/malware.txt | awk '{print $3}'` && 

     (
     
      if [ "$mlc" -ge 400 ]; 

        then 
        
          prt;
            
          echo -e "\e[1;31m Needs to suspend manually $urs.\e[0m"

      elif [ "$mlc" -lt 400 ] && [ "$mlc" -ge 1 ]; 

          then 
          
          prt;

      elif [ "$mlc" -eq 0 ]; 

          then 
          
          echo -e "\e[1;32m Nothing Suspicious for $urs.\e[0m";

      fi
     ) ; 

  done

) ; 

jobd ;

rm -vf /ramdisk/musers.txt* /ramdisk/mreports.txt;
